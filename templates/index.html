<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–Ω–æ-—Å–ø–æ—Ä—Ç–∏–≤–Ω—ñ –º–∏</title> {# –ó–ú–Ü–ù–ê –¢–£–¢: –ù–æ–≤–∞ –Ω–∞–∑–≤–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ #}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <div class="container">
        <h1 class="main-title"> {# –ó–ú–Ü–ù–ê –¢–£–¢: –î–æ–¥–∞–Ω–æ –∫–ª–∞—Å main-title #}
            <img src="{{ url_for('static', filename='favicon.png') }}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="main-title-icon"> {# –ù–û–í–ï: –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ñ–∞–≤—ñ–∫–æ–Ω—É #}
            –ê–∫—Ç–∏–≤–Ω–æ-—Å–ø–æ—Ä—Ç–∏–≤–Ω—ñ –º–∏ {# –ó–ú–Ü–ù–ê –¢–£–¢: –ù–æ–≤–∞ –Ω–∞–∑–≤–∞ #}
        </h1>

        <div class="auth-links">
            {% if current_user.is_authenticated %}
                <p>–ü—Ä–∏–≤—ñ—Ç, {{ current_user.username }}! 
                {% if current_user.is_admin() %}<span class="admin-label">(–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)</span>{% endif %}</p>
                <a href="{{ url_for('logout') }}">–í–∏–π—Ç–∏</a>
            {% else %}
                <a href="{{ url_for('login') }}">–£–≤—ñ–π—Ç–∏</a> | 
                <a href="{{ url_for('register') }}">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
            {% endif %}
        </div>

        <nav class="main-nav">
            <a href="{{ url_for('index') }}">–ü–æ–¥—ñ—ó</a>
            <a href="{{ url_for('announcements') }}">–û–≥–æ–ª–æ—à–µ–Ω–Ω—è</a>
            <a href="{{ url_for('polls') }}">–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è</a>
            
            {# –ù–û–í–ï: –í–∏–ø–∞–¥–∞—é—á–µ –º–µ–Ω—é –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ #}
            {% if current_user.is_authenticated and current_user.is_admin() %}
                <div class="dropdown">
                    <button class="dropbtn admin-action">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è ‚ñº</button>
                    <div class="dropdown-content">
                        <a href="{{ url_for('add_event') }}">–î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é</a>
                        <a href="{{ url_for('manage_fees') }}">–ö–µ—Ä—É–≤–∞—Ç–∏ –≤–Ω–µ—Å–∫–∞–º–∏</a>
                        <a href="{{ url_for('game_log') }}">–ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</a>
                        <a href="{{ url_for('fee_log') }}">–ñ—É—Ä–Ω–∞–ª –æ–ø–ª–∞—Ç</a>
                    </div>
                </div>
            {% endif %}
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {# –§–æ—Ä–º–∞ "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –ø–æ–¥—ñ—é" –±—É–ª–∞ —Ç—É—Ç, –∞–ª–µ —Ç–µ–ø–µ—Ä –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ dropdown –º–µ–Ω—é "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è" -> "–î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é" #}


        {# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä –ø–æ–¥—ñ–π –Ω–∞ 7 –¥–Ω—ñ–≤ #}
        {% if current_user.is_authenticated and user_events_next_7_days %}
            <div class="personal-calendar-section">
                <h2>–í–∞—à—ñ –ø–æ–¥—ñ—ó –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ 7 –¥–Ω—ñ–≤</h2>
                <ul>
                    {% for event in user_events_next_7_days %}
                        <li>
                            <strong>{{ event.name }}</strong> <span>( {{ format_datetime_for_display(event.date) }} )</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% elif current_user.is_authenticated %}
            <div class="personal-calendar-section info-message-box">
                <p>–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ 7 –¥–Ω—ñ–≤.</p>
            </div>
        {% endif %}


        <div class="events-list">
            <h2>–ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–¥—ñ—ó</h2>
            {% if events %}
                {% for event in events %}
                    <div class="event-card">
                        {% if event.image_url %}
                            <img src="{{ event.image_url }}" alt="{{ event.name }}" class="event-image">
                        {% endif %}
                        <h3>{{ event.name }} - {{ format_datetime_for_display(event.date) }}</h3>
                        {% set active_participants_count = 0 %}
                        {% for p_entry in event.processed_participants %}
                            {% if p_entry.status == 'active' %}
                                {% set active_participants_count = active_participants_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        <p>–£—á–∞—Å–Ω–∏–∫—ñ–≤: <strong>{{ active_participants_count }}</strong></p>
                        
                        <h4>–°–ø–∏—Å–æ–∫ —É—á–∞—Å–Ω–∏–∫—ñ–≤:</h4>
                        <ul>
                            {% for p_entry in event.processed_participants %}
                                <li>
                                    <div class="participant-details"> 
                                        {{ p_entry.username }} 
                                        {% if users_fee_status[p_entry.username] is defined and users_fee_status[p_entry.username] %}
                                            <span class="fee-paid-badge" title="–í–Ω–µ—Å–∫–∏ —Å–ø–ª–∞—á–µ–Ω–æ">&#10003;</span>
                                        {% endif %}
                                        
                                        {% if p_entry.assigned_team_name %}
                                            <span class="team-name-badge">{{ p_entry.assigned_team_name }} üòâ</span>
                                        {% endif %}
                                    </div>

                                    <span class="participation-info">
                                        (–ó–∞–ø–∏—Å: {{ format_datetime_for_display(p_entry.timestamp) }}
                                        {% if p_entry.status == 'cancelled' %}
                                            <span class="cancelled-badge">–í—ñ–¥–º–æ–≤–∏–≤—Å—è</span>
                                        {% endif %})
                                    </span>
                                </li>
                            {% else %}
                                <li>–ü–æ–∫–∏ —â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–≤—Å—è.</li>
                            {% endfor %}
                        </ul>

                        {% if current_user.is_authenticated %}
                            <form action="{{ url_for('toggle_participation', event_id=event.id) }}" method="POST">
                                <button type="submit">
                                    {% set user_is_active_participant = false %}
                                    {% for p_entry in event.participants %}
                                        {% if p_entry.username == current_user.username and p_entry.status == 'active' %}
                                            {% set user_is_active_participant = true %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if user_is_active_participant %}
                                        –°–∫–∞—Å—É–≤–∞—Ç–∏ —É—á–∞—Å—Ç—å
                                    {% else %}
                                        –Ø –∑–º–æ–∂—É
                                    {% endif %}
                                </button>
                            </form>
                            {% if current_user.is_admin() %}
                                <div class="admin-event-actions">
                                    <a href="{{ url_for('manage_teams', event_id=event.id) }}" class="admin-manage-teams-link small-button">–ö–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏</a>
                                    <a href="{{ url_for('edit_event', event_id=event.id) }}" class="admin-edit-event-link small-button">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                                    <form action="{{ url_for('delete_event', event_id=event.id) }}" method="POST" style="display: inline-block;">
                                        <button type="submit" class="admin-delete-event-btn small-button" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–æ–¥—ñ—é? –í—Å—ñ –¥–∞–Ω—ñ, –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ –∑ –Ω–µ—é (—É—á–∞—Å–Ω–∏–∫–∏, –∫–æ–º–∞–Ω–¥–∏), –±—É–¥—É—Ç—å –≤—Ç—Ä–∞—á–µ–Ω—ñ.');">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                    </form>
                                </div>
                            {% endif %}
                        {% else %}
                            <p>–ë—É–¥—å –ª–∞—Å–∫–∞, <a href="{{ url_for('login') }}">—É–≤—ñ–π—Ç–∏</a>, —â–æ–± –≤—ñ–¥–º—ñ—Ç–∏—Ç–∏ —É—á–∞—Å—Ç—å.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É –ø–æ–¥—ñ—é!</p>
            {% endif %}
        </div>
    </div>
</body>
</html>