{% extends "base.html" %}

{% block title %}Головна сторінка{% endblock %}

{% block content %}

    {% if current_user.is_authenticated %}
        <h2>Ваші події на наступні 7 днів</h2>
        {% endif %}

    <h2>Майбутні події</h2>

    {% for event in events %}
    <div class="event-card" id="event-{{ event.id }}">
        
        <h3>{{ event.title }} - {{ format_datetime_for_display(event.date) }}</h3>
        
        {% if event.max_participants %}
            <p><strong>Учасників:</strong> {{ event.participants.count() }} / {{ event.max_participants }}</p>
        {% else %}
            <p><strong>Учасників:</strong> {{ event.participants.count() }}</p>
        {% endif %}
        
        {% if current_user.is_authenticated %}
            {% set is_participant = event.participants.filter_by(user_id=current_user.id).first() %}
            {% if is_participant %}
                <button class="small-button" disabled style="background-color: #28a745; cursor: default;">Ви записані</button>
            {% elif event.is_open and (not event.max_participants or event.participants.count() < event.max_participants) %}
                <a href="{{ url_for('join_event', event_id=event.id) }}" class="small-button">Записатися</a>
            {% else %}
                 <button class="small-button" disabled style="background-color: #6c757d; cursor: default;">Місця закінчились</button>
            {% endif %}
        {% else %}
            <p><a href="{{ url_for('login') }}">Увійдіть</a>, щоб записатися.</p>
        {% endif %}


        <div class="event-participants-section">
            <h4>Список учасників:</h4>
            <ul>
                {% for participant in event.participants %}
                    <li class="participant-row" id="participant-{{ participant.user_id }}">
                        
                        <span class="participant-info-group">
                            <span class="participant-name">
                                {{ participant.user.nickname or participant.user.username }}
                            </span>
                            {% if participant.team_name %}
                                <span class="team-badge">{{ participant.team_name }}</span>
                            {% endif %}
                            
                            <span class="participation-info">
                                (Запис: {{ format_datetime_for_display(participant.join_date) }})
                            </span>
                        </span>

                        <span class="participant-actions-group">
                            
                            {% if current_user.is_authenticated and current_user.can_manage_events() and participant.stats %}
                                <span class="admin-stats">
                                    Тиждень: <strong>{{ participant.stats.weekly_count }}</strong>, 
                                    30 днів: <strong>{{ participant.stats.monthly_count }}</strong>
                                </span>
                            {% endif %}
                            
                            {% if current_user.is_authenticated and current_user.can_manage_events() %}
                                <button 
                                    class="remove-participant-btn" 
                                    onclick="promptAndRemoveParticipant({{ event.id }}, {{ participant.user_id }})"
                                    title="Зняти учасника з гри та залишити помітку"
                                >
                                    Зняти з гри
                                </button>
                            {% endif %}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        </div>
    {% endfor %}
    
    <script>
        function promptAndRemoveParticipant(eventId, userId) {
            // Запит помітки у адміністратора
            const reason = prompt(
                "Введіть помітку/причину видалення (наприклад: 'Перенесено на інший день'):", 
                "Перенесено на інший день"
            );

            // Якщо користувач натиснув "Скасувати" або ввів порожній рядок, виходимо
            if (reason === null || reason.trim() === "") {
                return;
            }

            // Створюємо форму для POST-запиту
            const form = document.createElement('form');
            form.method = 'POST';
            // Використовуємо url_for з Python, щоб отримати коректний URL
            form.action = "{{ url_for('remove_participant_api', event_id=0) }}".replace('0', eventId);
            
            // Поле для ID користувача
            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            form.appendChild(userIdInput);
            
            // Поле для причини/помітки
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'reason';
            reasonInput.value = reason;
            form.appendChild(reasonInput);

            // Додаємо форму до тіла документа і відправляємо її
            document.body.appendChild(form);
            form.submit();
        }
    </script>

{% endblock %}