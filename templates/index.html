{% extends "base.html" %}

{% block content %}
<div class="events-list">
    <h3>Заплановані події</h3>
    {% for event in events %}
        <div class="event-card" id="event-{{ event.id }}">
            <h2>{{ event.name }} <span class="event-date">{{ format_datetime_for_display(event.date) }}</span></h2>
            {% if event.comment %}<p class="event-comment">{{ event.comment | safe }}</p>{% endif %}
            
            <p>Учасників: <strong>{{ event.active_participants_count }}</strong>{% if event.max_participants %} / {{ event.max_participants }}{% endif %}</p>
            <h4>Список учасників:</h4>
            <ul>
                {% for p_entry in event.processed_participants %}
                    <li class="participant-row">
                        <span class="participant-info-group">
                            <span class="participant-name">{{ p_entry.nickname }}</span>
                            <span class="participation-info">(Запис: {{ format_datetime_for_display(p_entry.timestamp) }}
                                {% if p_entry.status == 'refused' %}<span class="cancelled-badge refused-status">Відмовився</span>
                                {% elif p_entry.status == 'removed' %}<span class="cancelled-badge removed-status">Грає в інший день</span>
                                {% endif %}
                            )</span>
                        </span>
                        
                        {% if current_user.is_authenticated and current_user.can_manage_events() %}
                            <span class="participant-actions-group">
                                {% if p_entry.stats %}
                                    <span class="admin-stats" title="Ігор на цьому тижні / за останні 30 днів">
                                        Тиждень: <strong>{{ p_entry.stats.weekly_count }}</strong>, 30 днів: <strong>{{ p_entry.stats.monthly_count }}</strong>
                                    </span>
                                {% endif %}
                                
                                {% if p_entry.user_id != current_user.id %}
                                    <form action="{{ url_for('admin_toggle_participant_status', event_id=event.id, user_id=p_entry.user_id) }}" method="POST" style="display: inline;">
                                        {% if p_entry.status == 'active' %}
                                            <button type="submit" class="remove-participant-btn" title="Зняти учасника з гри">Зняти</button>
                                        {% elif p_entry.status in ['removed', 'refused'] %}
                                            <button type="submit" class="button join-button small-button" title="Повернути учасника в гру">Повернути</button>
                                        {% endif %}
                                    </form>
                                {% endif %}
                            </span>
                        {% endif %}
                    </li>
                {% else %}
                    <li>Поки що ніхто не зареєструвався.</li>
                {% endfor %}
            </ul>

            {% if current_user.is_authenticated %}
                <form action="{{ url_for('toggle_participation', event_id=event.id) }}" method="POST" style="display: inline-block;">
                    {% set current_user_status = '' %}
                    {% for p in event.processed_participants if p.user_id == current_user.id %}
                        {% set current_user_status = p.status %}
                    {% endfor %}

                    {% if current_user_status == 'active' %}
                        <button type="submit" class="button cancel-button">Скасувати участь</button>
                    {% elif current_user_status == 'removed' %}
                        <button type="button" class="button join-button" disabled title="Адміністратор зняв вас з гри">Я зможу</button>
                    {% else %}
                        <button type="submit" class="button join-button">Я зможу</button>
                    {% endif %}
                </form>
                {% if current_user.can_manage_events() %}
                    <div class="admin-event-actions">
                        <a href="{{ url_for('manage_teams', event_id=event.id) }}" class="admin-manage-teams-link small-button">Керувати командами</a>
                        <a href="{{ url_for('edit_event', event_id=event.id) }}" class="admin-edit-event-link small-button">Редагувати</a>
                        <form action="{{ url_for('delete_event', event_id=event.id) }}" method="POST" style="display: inline-block;"><button type="submit" class="admin-delete-event-btn small-button" onclick="return confirm('Ви впевнені?');">Видалити</button></form>
                    </div>
                {% endif %}
            {% else %}
                <p>Будь ласка, <a href="{{ url_for('login') }}">увійдіть</a>, щоб відмітити участь.</p>
            {% endif %}
        </div>
    {% else %}
        <p>Наразі немає запланованих подій.</p>
    {% endfor %}
</div>
{% endblock %}