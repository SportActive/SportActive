<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–Ω–æ-—Å–ø–æ—Ä—Ç–∏–≤–Ω—ñ –º–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        .event-comment {
            background-color: #fffbe6;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 4px;
            font-style: italic;
            color: #5d4c15;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ä—è–¥–∫–∞ —É—á–∞—Å–Ω–∏–∫–∞ */
        .participant-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            flex-wrap: wrap; /* –î–æ–¥–∞–Ω–æ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—ñ */
        }

        .participant-name {
            font-weight: 600;
            color: #34495e;
        }
        
        /* –ù–û–í–Ü –°–¢–ò–õ–Ü –°–¢–ê–¢–£–°–Ü–í */
        .cancelled-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
            margin-left: 5px;
            white-space: nowrap;
        }
        .refused-status {
            background-color: #f8d7da; /* –ß–µ—Ä–≤–æ–Ω—É–≤–∞—Ç–∏–π –¥–ª—è –ø—ñ–∑–Ω—å–æ—ó –≤—ñ–¥–º–æ–≤–∏ */
            color: #721c24;
        }
        .removed-status {
            background-color: #ffc107; /* –ñ–æ–≤—Ç–∏–π –¥–ª—è –∑–Ω—è—Ç–æ–≥–æ –∞–¥–º—ñ–Ω–æ–º */
            color: #343a40;
        }

        .team-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: 700;
            color: #333; /* –ó–∞–ª–∏—à–∞—î–º–æ —Ç–µ–º–Ω–∏–º, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ –Ω–∞ –∫–æ–ª—å–æ—Ä–æ–≤–æ–º—É —Ñ–æ–Ω—ñ */
        }
        
        .remove-participant-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        .remove-participant-btn:hover {
            background-color: #c82333;
        }

        .admin-stats {
            font-size: 0.8em;
            color: #6c757d;
            border: 1px solid #ced4da;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 10px;
            white-space: nowrap;
        }

        .participant-info-group {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .participant-actions-group {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .fee-paid-badge {
            color: #28a745;
            font-weight: 700;
            margin-left: 5px;
            font-size: 1.1em;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">
            <img src="{{ url_for('static', filename='favicon.png') }}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="main-title-icon">
            –ê–∫—Ç–∏–≤–Ω–æ-—Å–ø–æ—Ä—Ç–∏–≤–Ω—ñ –º–∏
        </h1>

        <div class="auth-links">
            {% if current_user.is_authenticated %}
                <p>–ü—Ä–∏–≤—ñ—Ç, {{ current_user.nickname or current_user.username }}! 
                {% if current_user.is_admin() %}<span class="badge admin-badge">–ê–¥–º—ñ–Ω</span>{% endif %}
                {% if current_user.is_superuser() %}<span class="badge superuser-badge">–°—É–ø–µ—Ä–∞–¥–º—ñ–Ω</span>{% endif %}
                </p>
                <nav class="user-nav">
                    {% if current_user.can_view_finances() %}
                        <a href="{{ url_for('finances') }}" class="nav-link">–§—ñ–Ω–∞–Ω—Å–∏</a>
                    {% endif %}
                    <a href="{{ url_for('announcements') }}" class="nav-link {% if has_unread_announcements %}unread{% endif %}">–û–≥–æ–ª–æ—à–µ–Ω–Ω—è</a>
                    <a href="{{ url_for('polls') }}" class="nav-link {% if has_unread_polls %}unread{% endif %}">–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è</a>
                    {% if current_user.can_manage_events() %}
                        <a href="{{ url_for('game_log') }}" class="nav-link">–ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π</a>
                        <a href="{{ url_for('add_event') }}" class="nav-link primary-nav-link">–î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é</a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="nav-link logout-link">–í–∏–π—Ç–∏</a>
                </nav>
            {% else %}
                <a href="{{ url_for('login') }}" class="nav-link">–£–≤—ñ–π—Ç–∏</a>
                <a href="{{ url_for('register') }}" class="nav-link">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
            {% endif %}
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% if current_user.is_authenticated and user_events_next_7_days %}
        <div class="personal-calendar-section">
            <h3 class="section-title">–í–∞—à—ñ –ø–æ–¥—ñ—ó –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ 7 –¥–Ω—ñ–≤</h3>
            <ul class="clean-list">
                {% for event in user_events_next_7_days %}
                    <li>
                        <strong>{{ format_datetime_for_display(event.date) }}</strong>: 
                        <span>{{ event.name }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="events-list">
            <h3 class="section-title">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ –ø–æ–¥—ñ—ó</h3>
            {% if events %}
                {% for event in events %}
                    <div class="event-card" id="event-{{ event.id }}">
                        <h2 class="event-title">
                            {{ event.name }} 
                            <span class="event-date">{{ format_datetime_for_display(event.date) }}</span>
                        </h2>
                        
                        {% if event.image_url %}
                            <img src="{{ event.image_url }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–¥—ñ—ó" class="event-image">
                        {% endif %}

                        {% if event.comment %}
                            <p class="event-comment">{{ event.comment | safe }}</p>
                        {% endif %}

                        <div class="teams-container">
                            {% for team_name, members in event.teams.items() %}
                                <div class="team-block" style="background-color: {{ event.team_colors.get(team_name, '#e9ecef') }};">
                                    <h4 class="team-name-badge">{{ team_name }}</h4>
                                    <ul class="team-members">
                                        {% for member_username in members %}
                                            <li>{{ user_nicknames.get(member_username, member_username) }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        </div>

                        <p>–£—á–∞—Å–Ω–∏–∫—ñ–≤: <strong>{{ event.active_participants_count }}</strong>
                        {% if event.max_participants != None %}/ {{ event.max_participants }}{% endif %}
                        </p>
                        
                        <h4>–°–ø–∏—Å–æ–∫ —É—á–∞—Å–Ω–∏–∫—ñ–≤:</h4>
                        <ul>
                            {% for p_entry in event.processed_participants %}
                                <li class="participant-row" id="participant-{{ p_entry.user_id }}">
                                    
                                    <span class="participant-info-group">
                                        <span class="participant-name">
                                            {{ p_entry.nickname }} 
                                            {% if p_entry.username in paid_users_for_current_month %}
                                                <span class="fee-paid-badge" title="–í–Ω–µ—Å–æ–∫ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å —Å–ø–ª–∞—á–µ–Ω–æ">&#10003;</span>
                                            {% endif %}
                                        </span>
                                        
                                        {% if p_entry.assigned_team_name %}
                                            <span class="team-badge" style="background-color: {{ event.team_colors.get(p_entry.assigned_team_name, '#e9ecef') }};">
                                                {{ p_entry.assigned_team_name }} üòâ
                                            </span>
                                        {% endif %}

                                        <span class="participation-info">
                                            (–ó–∞–ø–∏—Å: {{ format_datetime_for_display(p_entry.timestamp) }}
                                                {% if p_entry.status == 'refused' %}
                                                    <span class="cancelled-badge refused-status">–í—ñ–¥–º–æ–≤–∏–≤—Å—è</span>
                                                {% elif p_entry.status == 'removed' %}
                                                    <span class="cancelled-badge removed-status" style="background-color: #ffc107; color: #343a40;">
                                                        –ó–Ω—è—Ç–∏–π (–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ —ñ–Ω—à–∏–π –¥–µ–Ω—å)
                                                    </span>
                                                {% endif %}
                                            )
                                        </span>
                                    </span>
                                    
                                    {% if current_user.is_authenticated and current_user.can_manage_events() %}
                                        <span class="participant-actions-group">
                                            
                                            {% if p_entry.stats and p_entry.status == 'active' %}
                                                <span class="admin-stats" title="–Ü–≥–æ—Ä –Ω–∞ —Ü—å–æ–º—É —Ç–∏–∂–Ω—ñ / –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 30 –¥–Ω—ñ–≤">
                                                    –¢–∏–∂–¥–µ–Ω—å: <strong>{{ p_entry.stats.weekly_count }}</strong>, 
                                                    30 –¥–Ω—ñ–≤: <strong>{{ p_entry.stats.monthly_count }}</strong>
                                                </span>
                                            {% endif %}
                                            
                                            {% if p_entry.status == 'active' %}
                                                <button 
                                                    class="remove-participant-btn" 
                                                    onclick="removeParticipantImmediately({{ event.id }}, {{ p_entry.user_id }})"
                                                    title="–ó–Ω—è—Ç–∏ —É—á–∞—Å–Ω–∏–∫–∞ –∑ –≥—Ä–∏ —Ç–∞ –ø–æ–∑–Ω–∞—á–∏—Ç–∏ '–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ —ñ–Ω—à–∏–π –¥–µ–Ω—å'">
                                                    –ó–Ω—è—Ç–∏
                                                </button>
                                            {% endif %}
                                        </span>
                                    {% endif %}

                                </li>
                            {% else %}
                                <li>–ü–æ–∫–∏ —â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–≤—Å—è.</li>
                            {% endfor %}
                        </ul>

                        {% if current_user.is_authenticated %}
                            {% set is_participant = EventParticipant.query.filter_by(event_id=event.id, user_id=current_user.id, status='active').first() %}
                            <form action="{{ url_for('toggle_participation', event_id=event.id) }}" method="POST" style="display: inline-block;">
                                <button type="submit" class="button {% if event.is_participant %}cancel-button{% else %}join-button{% endif %}">
                                    {% if event.is_participant %}–°–∫–∞—Å—É–≤–∞—Ç–∏ —É—á–∞—Å—Ç—å{% else %}–Ø –∑–º–æ–∂—É{% endif %}
                                </button>
                            </form>
                            {% if current_user.can_manage_events() %}
                                <div class="admin-event-actions">
                                    <a href="{{ url_for('manage_teams', event_id=event.id) }}" class="admin-manage-teams-link small-button">–ö–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏</a>
                                    {% if current_user.is_admin() %}
                                    <a href="{{ url_for('edit_event', event_id=event.id) }}" class="admin-edit-event-link small-button">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                                    <form action="{{ url_for('delete_event', event_id=event.id) }}" method="POST" style="display: inline-block;"><button type="submit" class="admin-delete-event-btn small-button" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?');">–í–∏–¥–∞–ª–∏—Ç–∏</button></form>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <p>–ë—É–¥—å –ª–∞—Å–∫–∞, <a href="{{ url_for('login') }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –≤—ñ–¥–º—ñ—Ç–∏—Ç–∏ —É—á–∞—Å—Ç—å.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π.</p>
            {% endif %}
        </div>
    </div>
    
    <script>
        function removeParticipantImmediately(eventId, userId) {
            // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥—ñ—ó
            if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–Ω—è—Ç–∏ —Ü—å–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞ –∑ –≥—Ä–∏? –ù–∞–ø–∏—Å –±—É–¥–µ '–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ —ñ–Ω—à–∏–π –¥–µ–Ω—å'.")) {
                return;
            }

            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–æ—Ä–º—É –¥–ª—è POST-–∑–∞–ø–∏—Ç—É
            const form = document.createElement('form');
            form.method = 'POST';
            // –í–∫–∞–∑—É—î–º–æ action –Ω–∞ API-–º–∞—Ä—à—Ä—É—Ç
            form.action = "{{ url_for('remove_participant_api', event_id=0) }}".replace('0', eventId);
            
            // –ü–æ–ª–µ –¥–ª—è ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            form.appendChild(userIdInput);
            
            // –ù–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω reasonInput, –æ—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–∏—á–∏–Ω–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
            
            // –î–æ–¥–∞—î–º–æ —Ñ–æ—Ä–º—É –¥–æ —Ç—ñ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —ó—ó
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>