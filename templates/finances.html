{% extends "base.html" %}

{% block title %}Керування фінансами{% endblock %}

{% block head_extra %}
<style>
    .summary-card { background-color: #f8fbfd; border: 1px solid #e0e9f0; border-radius: 10px; padding: 20px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .summary-item { padding: 10px; flex-grow: 1; min-width: 180px;}
    .summary-item h4 { margin: 0 0 10px 0; color: #4a698a; font-size: 1.1em; text-align: center; font-weight: 600; text-transform: uppercase;}
    .summary-item p { margin: 0; font-size: 1.8em; font-weight: 700; }
    .income { color: #28a745; }
    .expense { color: #dc3545; }
    .balance { color: #007bff; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .data-table th, .data-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee;}
    .data-table th { background-color: #f0f4f7; }
    .data-table tr:hover { background-color: #f6f9fc; }
    .log-actions { display: flex; justify-content: flex-start; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .fee-paid-status { color: #28a745; font-weight: bold; }
    .fee-unpaid-status { color: #dc3545; }
    .user-fees-list .data-table .td-username { max-width: 150px; word-break: break-all; }
    .user-fees-list .fee-update-row td { background-color: #f8f9fa; padding-top: 10px; padding-bottom: 10px; }
    .user-fees-list .inline-form { display: flex; align-items: center; gap: 8px; justify-content: flex-start; }
    .user-fees-list .inline-form input[type="date"],
    .user-fees-list .inline-form input[type="month"] { width: 140px; padding: 5px; }
    .user-fees-list .inline-form input[type="number"] { width: 90px; padding: 5px; }
    .inactive-user-row {
        background-color: #fff0f1 !important;
        font-style: italic;
    }
    .inactive-user-row td {
        color: #721c24;
    }
    .delete-user-btn {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9em;
        border: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
    <h2>Керування фінансами</h2>

    <div class="log-actions">
        <form action="{{ url_for('admin.finances') }}" method="GET" class="inline-form">
            <label for="period_filter">Показати звіт за місяць:</label>
            <input type="month" id="period_filter" name="period" value="{{ period_filter if period_filter else '' }}">
            <button type="submit" class="small-button">Фільтрувати</button>
        </form>
        <a href="{{ url_for('admin.export_finances', period=period_filter if period_filter else '') }}" class="small-button download-button">Завантажити звіт (CSV)</a>
    </div>

    {% if period_filter %}
    <h3>Звіт за {{ period_filter }}</h3>
    {% else %}
    <h3>Звіт за весь час</h3>
    {% endif %}

    <div class="summary-card">
        {% if period_filter %}
        <div class="summary-item"><h4>Баланс на початок</h4><p class="balance">{{ "%.2f"|format(summary.start_balance) }} грн</p></div>
        {% endif %}
        <div class="summary-item"><h4>Надходження</h4><p class="income">+ {{ "%.2f"|format(summary.total_income) }} грн</p></div>
        <div class="summary-item"><h4>Витрати</h4><p class="expense">- {{ "%.2f"|format(summary.total_expenses) }} грн</p></div>
        <div class="summary-item"><h4>Баланс на кінець</h4><p class="balance">{{ "%.2f"|format(summary.end_balance) }} грн</p></div>
    </div>

    {% if current_user.can_edit_finances() %}
        <div class="add-transaction-section form-section">
            <h2>Додати транзакцію</h2>
            <form action="{{ url_for('admin.finances', period=period_filter) }}" method="POST" class="form-narrow">
                <input type="hidden" name="form_type" value="add_transaction">
                <input type="text" name="description" placeholder="Опис (напр. Оренда залу)" required>
                <input type="date" name="date" required>
                <input type="number" name="amount" step="0.01" placeholder="Сума" required>
                <select name="transaction_type" required>
                    <option value="income">Надходження</option>
                    <option value="expense">Витрата</option>
                </select>
                <button type="submit">Додати запис</button>
            </form>
        </div>
    {% endif %}
    
    <h2>Історія операцій за {{ period_filter if period_filter else 'весь час' }}</h2>
    <div class="transactions-list">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Опис</th>
                    <th>Тип</th>
                    <th>Сума</th>
                    {% if current_user.can_edit_finances() %}<th>Дії</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.date }}</td>
                    <td>{{ t.description }}</td>
                    <td>{% if t.transaction_type == 'income' %}<span class="income">Дохід</span>{% else %}<span class="expense">Витрата</span>{% endif %}</td>
                    <td><strong class="{{ 'income' if t.transaction_type == 'income' else 'expense' }}">{{ "%.2f"|format(t.amount) }} грн</strong></td>
                    {% if current_user.can_edit_finances() %}
                    <td>
                        <div class="inline-form" style="gap: 5px;">
                            <a href="{{ url_for('admin.edit_transaction', transaction_id=t.id) }}" class="small-button" style="background-color: #ffc107; color: black;">Редагувати</a>
                            <form action="{{ url_for('admin.delete_transaction', transaction_id=t.id) }}" method="POST" style="margin: 0;"><button type="submit" class="small-button" style="background-color: #dc3545;" onclick="return confirm('Ви впевнені?');">Видалити</button></form>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="{{ 5 if current_user.can_edit_finances() else 4 }}">За цей період немає операцій.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if current_user.is_admin() %}
    <div class="user-fees-list">
        <h2>Керування користувачами та внесками</h2>
        
        <div class="summary-card" style="margin-bottom: 20px; justify-content: center; gap: 40px;">
            <div class="summary-item"><h4>Активних членів</h4><p class="income">{{ user_stats.active }}</p></div>
            <div class="summary-item"><h4>Неактивних членів</h4><p class="expense">{{ user_stats.inactive }}</p></div>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Логін</th>
                    <th>Нікнейм</th>
                    <th>Роль</th>
                    <th>Внесок (за поточний місяць)</th>
                    <th>Статус / Дії</th>
                </tr>
            </thead>
            <tbody>
                {% for data in users_data %}
                <tr class="{% if data.is_inactive %}inactive-user-row{% endif %}">
                    <td class="td-username">{{ data.user.username }}</td>
                    <td>{{ data.user.nickname or data.user.username }}</td>
                    <td>
                        <form action="{{ url_for('admin.update_user_role', user_id=data.user.id) }}" method="POST" class="inline-form">
                            <select name="role" onchange="this.form.submit()">
                                <option value="user" {% if data.user.role == 'user' %}selected{% endif %}>User</option>
                                <option value="superuser" {% if data.user.role == 'superuser' %}selected{% endif %}>Superuser</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        {% if data.user.username in paid_users_for_current_month %}
                            <span class="fee-paid-status">Сплачено &#10003;</span>
                        {% else %}
                            <span class="fee-unpaid-status">Не сплачено &#10007;</span>
                        {% endif %}
                    </td>
                    <td title="Остання активність: {{ data.last_activity }}">
                         {% if data.is_inactive %}
                            <form action="{{ url_for('delete_user', user_id=data.user.id) }}" method="POST" onsubmit="return confirm('Ви впевнені, що хочете видалити цього неактивного користувача? Йому буде надіслано сповіщення.');">
                                <button type="submit" class="delete-user-btn">Видалити</button>
                            </form>
                        {% else %}
                            Активний
                        {% endif %}
                    </td>
                </tr>
                <tr class="fee-update-row {% if data.is_inactive %}inactive-user-row{% endif %}">
                    <td colspan="5" style="padding-left: 40px;">
                        <form action="{{ url_for('admin.finances', period=period_filter) }}" method="POST" class="inline-form">
                            <input type="hidden" name="form_type" value="update_user_fee">
                            <input type="hidden" name="user_id" value="{{ data.user.id }}">
                            <label><strong>Оновити внесок:</strong></label>
                            <input type="date" name="fee_date" required>
                            <input type="month" name="payment_period" value="{{ period_filter if period_filter else '' }}" required>
                            <input type="number" name="fee_amount" step="0.01" placeholder="Сума" required>
                            <button type="submit" class="small-button">Оновити</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
{% endblock %}

